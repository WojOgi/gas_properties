<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gas Permeance and Selectivity Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
        color: #333;
      }
      h1,
      h2 {
        text-align: center;
        color: #2c3e50;
      }
      .section {
        background-color: #fff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .global-inputs,
      .button-container {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .gas-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
      }
      .gas-box {
        border: 1px solid #3498db;
        border-radius: 5px;
        padding: 10px;
        width: 150px;
        background-color: #ecf0f1;
      }
      .gas-box h3 {
        margin: 0 0 10px 0;
        color: #2980b9;
        font-size: 16px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
      }
      input[type="number"],
      input[type="text"] {
        width: 100px;
        padding: 3px;
        border: 1px solid #bdc3c7;
        border-radius: 3px;
      }
      button {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background-color: #c0392b;
      }
      #clearButton {
        background-color: #7f8c8d;
      }
      #exportButton {
        background-color: #2ecc71;
      }
      #importButton {
        background-color: #3498db;
      }
      #results-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }
      .sample-result {
        border: 1px solid #bdc3c7;
        border-radius: 5px;
        padding: 10px;
        background-color: #fff;
        width: 220px;
        cursor: grab;
      }
      .sortable-ghost {
        opacity: 0.4;
        background-color: #dcdde1;
      }
    </style>
  </head>
  <body>
    <h1>Gas Permeance and Selectivity Calculator</h1>
    <div class="section global-inputs">
      <label>Sample Name: <input type="text" id="sampleName" /></label>
      <label>Area (cm²): <input type="number" id="area" step="0.01" /></label>
      <label
        >Pressure (bar): <input type="number" id="pressure" step="0.01"
      /></label>
    </div>
    <div class="section gas-container" id="gas-inputs"></div>
    <div class="section button-container">
      <button onclick="calculatePermeances()">Calculate</button>
      <button id="clearButton" onclick="clearStoredResults()">Clear</button>
      <button id="exportButton" onclick="exportStoredResults()">Export</button>
      <button
        id="importButton"
        onclick="document.getElementById('importFile').click()"
      >
        Import
      </button>
      <input
        type="file"
        id="importFile"
        accept=".json"
        onchange="importStoredResults(event)"
        style="display: none"
      />
    </div>

    <div class="section">
      <h2>Permeance Comparison</h2>
      <select id="permeanceGas" onchange="updatePermeanceChart()">
        <option value="H2">H2</option>
        <option value="He">He</option>
        <option value="O2">O2</option>
        <option value="N2">N2</option>
        <option value="CH4">CH4</option>
        <option value="CO2">CO2</option>
      </select>
      <canvas id="permeanceChart" height="120"></canvas>
    </div>

    <div class="section">
      <h2>Selectivity Comparison</h2>
      <select id="selectivityType" onchange="updateSelectivityChart()">
        <option value="H2/N2">H2/N2</option>
        <option value="O2/N2">O2/N2</option>
        <option value="CO2/CH4">CO2/CH4</option>
        <option value="CO2/N2">CO2/N2</option>
        <option value="H2/CH4">H2/CH4</option>
        <option value="H2/CO2">H2/CO2</option>
        <option value="N2/CH4">N2/CH4</option>
        <option value="He/H2">He/H2</option>
        <option value="H2/O2">H2/O2</option>
      </select>
      <canvas id="selectivityChart" height="120"></canvas>
    </div>

    <div class="section" id="stored-results">
      <h2>Stored Results</h2>
      <div id="results-container"></div>
    </div>

    <script>
      const storedResults = [];
      let resultCounter = 0;
      let selectivityChart, permeanceChart;

      function appendStoredResult(inputs, permeances, id) {
        const container = document.getElementById("results-container");
        container.insertAdjacentHTML(
          "beforeend",
          `
    <div class="sample-result" data-id="${id}" data-inputs='${JSON.stringify(
            inputs
          )}'>
      <h3>${inputs.sampleName}</h3>
      <div>Area: ${inputs.area.toFixed(
        2
      )} cm²<br>Pressure: ${inputs.pressure.toFixed(2)} bar</div>
      <h4>Permeances (GPU)</h4>
      ${Object.keys(permeances)
        .map((g) => `<p>${g}: ${permeances[g].toFixed(2)}</p>`)
        .join("")}
    </div>
  `
        );
        storedResults.push({ inputs, permeances });
        updateSelectivityChart();
        updatePermeanceChart();
      }

      function updateSelectivityChart() {
        const type = document.getElementById("selectivityType").value;
        const [num, den] = type.split("/");
        const labels = storedResults.map((r) => r.inputs.sampleName);
        const data = storedResults.map((r) =>
          (r.permeances[den] !== 0
            ? r.permeances[num] / r.permeances[den]
            : 0
          ).toFixed(2)
        );
        if (selectivityChart) selectivityChart.destroy();
        const ctx = document
          .getElementById("selectivityChart")
          .getContext("2d");
        selectivityChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: `${type} Selectivity`,
                data,
                backgroundColor: "#3498db",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "Selectivity" },
              },
            },
          },
        });
      }

      function updatePermeanceChart() {
        const gas = document.getElementById("permeanceGas").value;
        const labels = storedResults.map((r) => r.inputs.sampleName);
        const data = storedResults.map((r) => r.permeances[gas].toFixed(2));
        if (permeanceChart) permeanceChart.destroy();
        const ctx = document.getElementById("permeanceChart").getContext("2d");
        permeanceChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: `${gas} Permeance (GPU)`,
                data,
                backgroundColor: "#2ecc71",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "Permeance (GPU)" },
              },
            },
          },
        });
      }

      function exportStoredResults() {
        const results = Array.from(
          document.querySelectorAll(".sample-result")
        ).map((div) => {
          const inputs = JSON.parse(div.dataset.inputs);
          const permeances = calculatePermeancesFromInputs(inputs);
          return { inputs, permeances };
        });

        if (results.length === 0) {
          alert("No results to export.");
          return;
        }

        const blob = new Blob([JSON.stringify(results, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "stored_results.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function importStoredResults(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const results = JSON.parse(e.target.result);
            results.forEach((result) => {
              appendStoredResult(
                result.inputs,
                result.permeances,
                resultCounter++
              );
            });
          } catch (err) {
            alert("Import error: " + err.message);
          }
        };
        reader.readAsText(file);
        document.getElementById("importFile").value = "";
      }

      new Sortable(document.getElementById("results-container"), {
        animation: 150,
        ghostClass: "sortable-ghost",
        onEnd: function () {
          const updated = [];
          document.querySelectorAll(".sample-result").forEach((div) => {
            const inputs = JSON.parse(div.dataset.inputs);
            const permeances = calculatePermeancesFromInputs(inputs);
            updated.push({ inputs, permeances });
          });
          storedResults.length = 0;
          storedResults.push(...updated);
          updateSelectivityChart();
          updatePermeanceChart();
        },
      });

      function calculatePermeancesFromInputs(inputs) {
        const BAR_TO_CMHG = 75.006156130264;
        const p_cmHg = inputs.pressure * BAR_TO_CMHG;
        const permeances = {};
        for (const gas of Object.keys(inputs.gases)) {
          const V = inputs.gases[gas].volume;
          const t = inputs.gases[gas].time;
          permeances[gas] =
            inputs.area !== 0 && t !== 0 && p_cmHg !== 0
              ? (V / (inputs.area * t * p_cmHg)) * 1e6
              : 0;
        }
        return permeances;
      }
    </script>
  </body>
</html>
